{"data":{},"__content":"<p>å¤šäº†ä¸€ä¸ªmemory_pool</p>\n<pre><code class=\"language-plaintext\">PoolNode\nPool\n  m_block_size\n  m_block_per_chunk ä¸€ä¸ªchunkå†…çš„blockçš„æ•°é‡\n  PoolNode m_heade å¤´çš„åœ°å€ PoolNode\n  m_chunks å­˜æ¯ä¸€ä¸ªchunkçš„æŒ‡é’ˆ\n  alloc() ç”³è¯·å†…å­˜ ,head éç©ºå°±ä»headé‡Œå–\n  free() é‡Šæ”¾å†…å­˜,ä¸æ˜¯çœŸçš„é‡Šæ”¾,è¿˜æ˜¯å­˜æˆä¸€ä¸ªé“¾è¡¨\nFreeNode\nPoolBlock ?\n\nPoolImpl\n\nåŒ…å«å…³ç³» \n---&gt; PoolImpl( PoolBlock(FreeNode))\nPoolResource(PoolImpl)\nFixPoolResource(Pool) Fixæ˜¯å›ºå®šçš„æ„æ€å—?\n\nStackfulPoolArg \nstruct StackfulPool è¿™ä¸ªæ˜¯åšä»€ä¹ˆçš„????\n\nclass FixPoolResource : public std::pmr::memory_resource\n\nclass PoolResource : public std::pmr::memory_resource\n</code></pre>\n<p>example ä¸‹é¢æœ‰ä¸€ä¸ª<code>memory_pool</code>çš„æµ‹è¯•,å¯ä»¥å¸®åŠ©ç†è§£ä»£ç </p>\n<h2 id=\"lockcore.cpp-%E8%A7%A3%E6%9E%90\" tabindex=\"-1\">lockcore.cpp è§£æ</h2>\n<p>lockcoreçš„å®šä¹‰,åº”è¯¥æ˜¯é”çš„æŠ½è±¡,ä¸»è¦çš„ä½œç”¨åº”è¯¥æ˜¯ç»™é˜Ÿåˆ—åŠ ä¸Šé”ğŸ”’</p>\n<p>å®ç°ä¸€ä¸ªæ— é”(lockfree)é˜Ÿåˆ—</p>\n<pre><code class=\"language-plaintext\">æˆå‘˜å˜é‡ Queue-&gt; ä¸€ä¸ªå†…éƒ¨å­˜å‚¨ ListNodeçš„é˜Ÿåˆ—\n\nå¸¸é‡æ ‡è®°\nstatic constexpr int k_mtx_locked = 1; å·²é”\nstatic constexpr int k_que_locked = 2; é˜Ÿåˆ—å·²é”\nstatic constexpr int k_que_notempty = 4; é˜Ÿåˆ—ä¸ç©º\n\nstd::atomic&lt;int&gt; m_flags = 0; åŸå­æ ‡è®°flag\n\nis_locked æç¤ºå½“å‰æ˜¯å¦è·å¾—é”\n</code></pre>\n<p>åˆ†æ<code>try_lock</code>å‡½æ•°,æ³¨é‡Šè¯´å®ƒå®Œçš„çš„åŠŸèƒ½å¦‚ä¸‹:</p>\n<ul>\n<li>å¦‚æœ<code>mutex</code>å·²é”,è¿”å›true</li>\n<li>å¦åˆ™,åŠ å…¥<code>listNode *p</code>,è¿”å›false</li>\n</ul>\n<p><code>compare_exchange_strong</code></p>\n<h3 id=\"%E9%87%8D%E7%82%B9%3Atry_lock%E7%9A%84%E8%BF%87%E7%A8%8B\" tabindex=\"-1\">é‡ç‚¹:<code>try_lock</code>çš„è¿‡ç¨‹</h3>\n<pre><code class=\"language-plaintext\">\nlockcoreçš„æˆå‘˜å˜é‡è®¾å®šäº†ä¸€ä¸ªçŠ¶æ€:m_flags,å®ƒæ˜¯ä¸€ä¸ªä¸‰å…ƒçŠ¶æ€,[4,2,1],åˆ†åˆ«è¡¨ç¤º\nque_notempty,que_locked,mtx_locked\n\n1.å¾—åˆ° old_flag,ä¹Ÿå°±æ˜¯æ­¤æ—¶,m_flagsçš„çŠ¶æ€\n\nè¿›è¡Œç¬¬ä¸€è½®çš„é”\n\n- æ˜¯å¦å·²ç» é” mtx_locked -- NO --&gt; CAS(old_flag,mtx_locked)\n  -- yes--&gt; old_flag.clear(que_locked)  ä¿è¯que_locked æ— é”\n      ---&gt; CAS(old_flags,flag)\n\nç¬¬äºŒé˜¶æ®µ,\n\nenque true -&gt; æ­¤æ—¶é”äº† que_locked ,å¦åˆ™ é”äº† mtx_locked\n\nè¦ä¹ˆé”äº† mtx_locked\nè¦ä¹ˆé”äº† que_locked\n\nå¦‚æœ mtx_locked,åœ¨debugçš„çŠ¶æ€ä¸‹\n    -&gt; mtx_thd_cnt+=1 è®°å½•æœ‰å‡ ä¸ªçº¿ç¨‹ é€šè¿‡ mtx_locked é”ä½,å ç”¨çš„çº¿ç¨‹\n    -&gt; return true ,è¡¨ç¤ºé”ä½äº†?\n\nå¦‚æœ que_locked,åœ¨debugçš„çŠ¶æ€ä¸‹\n\n  m_que.push(p)\n    get_old_flag\n    flag.clear(que_locked)\n    flag.set(que_notempty)\n    CAS(old_flags,flag)\n    ç¡®å®æ¸…é™¤äº† que_locked æ ‡è®°\n\n\n</code></pre>\n<h3 id=\"%E9%87%8D%E7%82%B9%3Aunlock%E7%9A%84%E8%BF%87%E7%A8%8B\" tabindex=\"-1\">é‡ç‚¹:<code>unlock</code>çš„è¿‡ç¨‹</h3>\n<pre><code>unlock å‘ç”Ÿçš„äº‹æƒ…\n\nå¾—åˆ° old_flags\n\nç¬¬ä¸€é˜¶æ®µ\n  que_empty -&gt; yes -- &gt; flag = clear mtx_mtx_locked -&gt;[ 0|0|0]\n  |\n  |\n  No\n    flag = old_flags | que_locked\n    old_flags -&gt; clear que_locked\nCAS(old_flags ,flag) -&gt; æ”¹æˆæ–°çš„çŠ¶æ€\næ€»ç»“:unlock ä¸‹\n  å¦‚æœ é˜Ÿåˆ—ç©º -&gt; m_flag å˜æˆ 000\n  ä¸ç©º flagä¸ºold_flagåŠ ä¸Šque_locked,åŒæ—¶ä¿è¯CASæ—¶old_flagæ— que_locked\n\nå¦‚æœque_empty \n  return nullptr\nelse head = que.pop()\n\nç¬¬äºŒé˜¶æ®µ\n\n\nflag que_notempty or que_locked\n\nCAS(old_flags,flag), æ¸…ç©º que_locked é”\n\n</code></pre>\n<p>å¯ä»¥æŠŠæ•´ä¸ªlockcoreè®¤ä¸ºæ˜¯ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„æ— é”çš„é˜Ÿåˆ—</p>\n<h2 id=\"mutex.cpp-%E8%A7%A3%E6%9E%90\" tabindex=\"-1\">mutex.cpp è§£æ</h2>\n<p>example ç›®å½•ä¸‹çš„<code>mutex.cpp</code>å†™çš„æ˜¯<code>mutex.h</code>çš„æµ‹è¯•,ç†è§£è¿™ä¸ªä»£ç å¯ä»¥ç†è§£<code>mutex.h</code>ä»£ç çš„ç›®çš„.</p>\n<h3 id=\"1.-mutex.lock()%E7%9A%84%E4%BD%9C%E7%94%A8\" tabindex=\"-1\">1. <code>mutex.lock()</code>çš„ä½œç”¨</h3>\n<p>!!! å®ƒåŠ ä¸Šçš„é”çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?æˆ–è€…è¯´æ˜åŠ é”çš„ç›®çš„æ˜¯ä»€ä¹ˆ?</p>\n<p>å‡½æ•°å®šä¹‰,è¿”å›ä¸€ä¸ª<code>MutexLockAwaiter</code>å¯¹è±¡</p>\n<pre><code class=\"language-plaintext\">MutexLockAwaiter lock(IoContext &amp;ctx)\n{\n    return {*this, *ctx.get_io_ctx_base()};\n}\n</code></pre>\n<p>ä¸€ä¸ª<code>awaiter</code>å¯¹è±¡è¿è¡Œçš„è¿‡ç¨‹æ˜¯</p>\n<p><code>MutexLockAwaiter</code>å¯¹è±¡çš„ä¸»è¦</p>\n<pre><code class=\"language-plaintext\">await_ready -&gt; false æ‰€ä»¥ç›´æ¥æŒ‚èµ·äº†\n|\nV\nå¾—åˆ° suspended_coroutine_base\n\n-&gt; æ ¸å¿ƒæ˜¯è°ƒç”¨äº†m_mutexçš„m_lockcore-&gt;try_lock(m_node)\n\nå¦‚ä½• \n\nå½“ç¬¬ä¸€æ¬¡æ‰§è¡Œmtx.lockæ—¶,m_lockcoreé‡Œçš„å…ƒç´ m_flagä¸º000,ä¹Ÿå°±æ˜¯flag_mtx_locked = 0\næ‰€ä»¥m_lockcore.try_lock() è¿”å›true\nm_lockcore-&gt; try_lock è®¾ç½®äº† mtx_locked -&gt; own_mtx = true -&gt; !own_mtx = false\n      å½“å‰çš„åç¨‹æ²¡æœ‰æŒ‚èµ·\n\nå¦‚ä½• m_lockcore-&gt; try_lock è®¾ç½®äº† mtx_que_locked -&gt; own_mtx = false -&gt; !own_mtx = true\n      q å…¥é˜Ÿäº†\n      å½“å‰çš„åç¨‹æ²¡æœ‰æŒ‚èµ·,\n</code></pre>\n<pre><code class=\"language-plaintext\">mtx.unlock\n\nä»lockcoreé‡Œå–å‡º awaiter\n\nåŠ å…¥åˆ°ctxçš„task list\n</code></pre>\n"}